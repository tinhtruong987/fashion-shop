<div class="flex h-screen bg-gray-100">
  <!-- Danh sách sản phẩm -->
  <div class="w-2/3 p-4 overflow-y-auto">
    <div class="mb-4">
      <span class="p-input-icon-left w-full">
        <i class="pi pi-search"></i>
        <input
          type="text"
          pInputText
          placeholder="Tìm kiếm sản phẩm..."
          class="w-full"
        />
      </span>
    </div>

    <div class="grid grid-cols-3 gap-4">
      <div
        *ngFor="let product of products"
        class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-shadow"
        [class.border-2]="selectedProduct?.productID === product.productID"
        [class.border-blue-500]="
          selectedProduct?.productID === product.productID
        "
        (click)="selectProduct(product)"
      >
        <div class="aspect-w-1 aspect-h-1 mb-2">
          <img
            [src]="product.images?.[0]?.content || 'assets/images/placeholder.png'"
            [alt]="product.name"
            class="object-cover rounded"
          />
        </div>
        <h3 class="font-semibold text-gray-900">{{ product.name }}</h3>
        <p class="text-sm text-gray-500">{{ product.productCode }}</p>
        <p class="text-lg font-bold text-blue-600 mt-2">
          {{ product.price | currency : "VND" }}
        </p>
      </div>
    </div>
  </div>

  <!-- Giỏ hàng -->
  <div class="w-1/3 bg-white shadow-lg p-4 flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Giỏ hàng</h2>
      <p-button
        icon="pi pi-trash"
        label="Xóa giỏ"
        styleClass="p-button-text p-button-danger"
        (onClick)="clearCart()"
      ></p-button>
    </div>

    <!-- Thông tin sản phẩm đã chọn -->
    <div *ngIf="selectedProduct" class="mb-4 p-4 bg-gray-50 rounded-lg">
      <h3 class="font-semibold mb-2">{{ selectedProduct.name }}</h3>
      <div class="flex gap-2 mb-2">
        <p-dropdown
          [options]="selectedProduct.variants"
          [(ngModel)]="selectedVariant"
          optionLabel="size.sizeName"
          placeholder="Chọn size"
          styleClass="w-full"
        ></p-dropdown>
        <p-dropdown
          [options]="selectedProduct.variants"
          [(ngModel)]="selectedVariant"
          optionLabel="color.colorName"
          placeholder="Chọn màu"
          styleClass="w-full"
        ></p-dropdown>
      </div>
      <div class="flex items-center gap-2">
        <p-inputNumber
          [(ngModel)]="quantity"
          [min]="1"
          [max]="selectedVariant?.stock"
          styleClass="w-24"
        ></p-inputNumber>
        <p-button
          icon="pi pi-plus"
          label="Thêm vào giỏ"
          (onClick)="addToCart()"
          [disabled]="!selectedVariant"
        ></p-button>
      </div>
    </div>

    <!-- Danh sách sản phẩm trong giỏ -->
    <div class="flex-grow overflow-y-auto">
      <div
        *ngFor="let item of cartItems"
        class="flex items-center gap-4 p-2 border-b"
      >
        <div class="flex-grow">
          <h4 class="font-semibold">{{ getProductName(item) }}</h4>
          <p class="text-sm text-gray-500">
            Size: {{ item.variant.size?.sizeName }} | Màu:
            {{ item.variant.color?.colorName }}
          </p>
          <div class="flex items-center gap-2 mt-1">
            <p-inputNumber
              [(ngModel)]="item.quantity"
              [min]="1"
              [max]="item.variant.stock"
              styleClass="w-20"
              (onInput)="updateQuantity(item.variant.variantID, $event)"
            ></p-inputNumber>
            <span class="text-blue-600 font-semibold">
              {{ item.price * item.quantity | currency : "VND" }}
            </span>
          </div>
        </div>
        <p-button
          icon="pi pi-trash"
          styleClass="p-button-text p-button-danger"
          (onClick)="removeFromCart(item.variant.variantID)"
        ></p-button>
      </div>
    </div>

    <!-- Tổng tiền và thanh toán -->
    <div class="mt-4 space-y-4">
      <div class="flex justify-between text-lg">
        <span>Tổng tiền:</span>
        <span class="font-bold">{{ getTotalAmount() | currency : "VND" }}</span>
      </div>
      <div class="flex justify-between text-lg" *ngIf="voucher">
        <span>Giảm giá:</span>
        <span class="font-bold text-red-500"
          >-{{ getDiscountAmount() | currency : "VND" }}</span
        >
      </div>
      <div class="flex justify-between text-xl border-t pt-2">
        <span>Thành tiền:</span>
        <span class="font-bold text-blue-600">{{
          getFinalAmount() | currency : "VND"
        }}</span>
      </div>

      <div class="flex gap-2">
        <p-button
          icon="pi pi-user"
          label="Khách hàng"
          styleClass="flex-grow"
          (onClick)="openCustomerDialog()"
        ></p-button>
        <p-button
          icon="pi pi-ticket"
          label="Voucher"
          styleClass="flex-grow"
        ></p-button>
      </div>

      <p-button
        icon="pi pi-credit-card"
        label="Thanh toán"
        styleClass="w-full"
        [disabled]="cartItems.length === 0"
        (onClick)="openPaymentDialog()"
      ></p-button>
    </div>
  </div>
</div>

<!-- Dialog thông tin khách hàng -->
<p-dialog
  [(visible)]="displayCustomerDialog"
  header="Thông tin khách hàng"
  [modal]="true"
  [style]="{ width: '450px' }"
>
  <form [formGroup]="customerForm" class="space-y-4">
    <div class="field">
      <label for="name" class="block mb-2">Tên khách hàng</label>
      <input
        id="name"
        type="text"
        pInputText
        formControlName="name"
        class="w-full"
      />
    </div>

    <div class="field">
      <label for="phone" class="block mb-2">Số điện thoại</label>
      <input
        id="phone"
        type="text"
        pInputText
        formControlName="phone"
        class="w-full"
      />
    </div>

    <div class="field">
      <label for="email" class="block mb-2">Email</label>
      <input
        id="email"
        type="email"
        pInputText
        formControlName="email"
        class="w-full"
      />
    </div>

    <div class="field">
      <label for="address" class="block mb-2">Địa chỉ</label>
      <textarea
        id="address"
        pInputTextarea
        formControlName="address"
        [rows]="3"
        class="w-full"
      ></textarea>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-button
      icon="pi pi-times"
      label="Hủy"
      styleClass="p-button-text"
      (onClick)="displayCustomerDialog = false"
    ></p-button>
    <p-button
      icon="pi pi-check"
      label="Lưu"
      (onClick)="saveCustomer()"
      [disabled]="customerForm.invalid"
    ></p-button>
  </ng-template>
</p-dialog>

<!-- Dialog thanh toán -->
<p-dialog
  [(visible)]="displayPaymentDialog"
  header="Thanh toán"
  [modal]="true"
  [style]="{ width: '450px' }"
>
  <form [formGroup]="paymentForm" class="space-y-4">
    <div class="field">
      <label for="paymentMethod" class="block mb-2"
        >Phương thức thanh toán</label
      >
      <p-dropdown
        id="paymentMethod"
        [options]="[
          { label: 'Tiền mặt', value: 'Cash' },
          { label: 'Thẻ tín dụng', value: 'CreditCard' },
          { label: 'Thẻ ghi nợ', value: 'DebitCard' },
          { label: 'Chuyển khoản', value: 'BankTransfer' }
        ]"
        formControlName="paymentMethod"
        optionLabel="label"
        optionValue="value"
        class="w-full"
      ></p-dropdown>
    </div>

    <div class="field">
      <label for="amount" class="block mb-2">Số tiền</label>
      <p-inputNumber
        id="amount"
        formControlName="amount"
        mode="currency"
        currency="VND"
        locale="vi-VN"
        class="w-full"
      ></p-inputNumber>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-button
      icon="pi pi-times"
      label="Hủy"
      styleClass="p-button-text"
      (onClick)="displayPaymentDialog = false"
    ></p-button>
    <p-button
      icon="pi pi-check"
      label="Xác nhận"
      (onClick)="processPayment()"
      [disabled]="paymentForm.invalid"
    ></p-button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
